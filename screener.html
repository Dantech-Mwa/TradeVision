<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Screener - TradeVision</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #141518;
      --bg-light: #1e222d;
      --text: #d1d4dc;
      --text-light: #9ea1b5;
      --accent: #2962ff;
      --accent-hover: #1e53e5;
      --green: #26a69a;
      --green-light: rgba(38, 166, 154, 0.1);
      --red: #ef5350;
      --red-light: rgba(239, 83, 80, 0.1);
      --border: #2d313e;
      --card: #1e222d;
      --card-hover: #252a38;
      --table-header: #252a38;
      --table-row: #1e222d;
      --table-row-hover: #252a38;
      --shadow: rgba(0, 0, 0, 0.2);
    }
    
    [data-theme="light"] {
      --bg: #ffffff;
      --bg-light: #f8f9fa;
      --text: #2d3748;
      --text-light: #718096;
      --accent: #2962ff;
      --accent-hover: #1e53e5;
      --green: #26a69a;
      --green-light: rgba(38, 166, 154, 0.05);
      --red: #ef5350;
      --red-light: rgba(239, 83, 80, 0.05);
      --border: #e2e8f0;
      --card: #ffffff;
      --card-hover: #f8f9fa;
      --table-header: #f1f5f9;
      --table-row: #ffffff;
      --table-row-hover: #f8fafc;
      --shadow: rgba(0, 0, 0, 0.05);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
    }
    
    a {
      color: var(--accent);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    a:hover {
      color: var(--accent-hover);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    
    .header {
      background: var(--bg-light);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      transition: background-color 0.3s, border-color 0.3s;
    }
    
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .flex-center {
      display: flex;
      align-items: center;
    }
    
    .logo {
      font-weight: 700;
      font-size: 1.4rem;
      color: var(--accent);
    }
    
    .logo i {
      font-size: 1.5rem;
      margin-right: 0.5rem;
    }
    
    .nav-links a {
      margin: 0 0.75rem;
      font-weight: 500;
      position: relative;
    }
    
    .nav-links a:hover::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent);
    }
    
    .icon-btn {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .icon-btn:hover {
      background: var(--border);
      color: var(--text);
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
    }
    
    .page-subtitle {
      color: var(--text-light);
      margin-top: 0.5rem;
    }
    
    .page-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--accent-hover);
    }
    
    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-outline:hover {
      background: var(--border);
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: var(--card);
      border-radius: 8px;
      padding: 1rem 1.5rem;
      flex: 1;
      min-width: 150px;
      box-shadow: 0 2px 10px var(--shadow);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .stat-change {
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    
    .stat-change.positive {
      color: var(--green);
    }
    
    .stat-change.negative {
      color: var(--red);
    }

    /* Filters Section */
    .filters-section {
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow);
      margin-bottom: 1.5rem;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    .filters-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .filters-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .filters-toggle {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .filters-content {
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .filter-group {
      margin-bottom: 0;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-light);
    }
    
    .filter-group input, .filter-group select {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      width: 100%;
      font-size: 0.9rem;
      transition: border-color 0.2s, background-color 0.3s, color 0.3s;
    }
    
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
    }

    /* Search Dropdown */
    #symbol-search-container {
      position: relative;
    }
    
    #symbol-search-input {
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      width: 100%;
      font-size: 0.9rem;
      transition: border-color 0.2s, background-color 0.3s, color 0.3s;
    }
    
    #symbol-search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
    }
    
    #symbol-search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: 0 4px 12px var(--shadow);
      display: none;
    }
    
    .symbol-option {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s;
    }
    
    .symbol-option:hover {
      background: var(--bg-light);
    }
    
    .symbol-option:last-child {
      border-bottom: none;
    }

    /* Table Section */
    .table-section {
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px var(--shadow);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    .table-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .table-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .table-actions select {
      padding: 0.5rem;
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }
    
    th {
      background: var(--table-header);
      font-weight: 600;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    
    th.sortable:hover {
      background: var(--card-hover);
    }
    
    th.sortable::after {
      content: 'â†•';
      margin-left: 0.5rem;
      opacity: 0.5;
    }
    
    th.sort-asc::after {
      content: 'â†‘';
      opacity: 1;
    }
    
    th.sort-desc::after {
      content: 'â†“';
      opacity: 1;
    }
    
    tbody tr {
      background: var(--table-row);
      transition: background-color 0.2s;
    }
    
    tbody tr:hover {
      background: var(--table-row-hover);
    }
    
    .symbol {
      font-weight: 600;
    }
    
    .change {
      color: var(--green);
      font-weight: 500;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: var(--green-light);
      display: inline-block;
    }
    
    .change.negative {
      color: var(--red);
      background: var(--red-light);
    }
    
    .action-btn {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    .action-btn:hover {
      background: var(--accent-hover);
    }
    
    .action-btn:active {
      transform: scale(0.98);
    }
    
    .action-btn.added {
      background: var(--green);
      cursor: default;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }
    
    .no-results {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }

    /* Status */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-connected {
      background: var(--green);
    }
    
    .status-connecting {
      background: #ff9800;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .status-disconnected {
      background: var(--red);
    }

    /* Export Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: var(--card);
      border-radius: 8px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px var(--shadow);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .export-options {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .export-option {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .export-option:hover {
      background: var(--bg-light);
    }
    
    .export-option.selected {
      border-color: var(--accent);
      background: rgba(41, 98, 255, 0.05);
    }
    
    .export-icon {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: white;
    }
    
    .export-info h4 {
      margin: 0 0 0.25rem 0;
      font-weight: 600;
    }
    
    .export-info p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Footer */
    .footer {
      background: var(--bg-light);
      border-top: 1px solid var(--border);
      padding: 1rem 0;
      font-size: 0.8rem;
      text-align: center;
      color: var(--text-light);
      transition: background-color 0.3s, border-color 0.3s;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filters-content {
        grid-template-columns: 1fr;
      }
      
      .nav-links {
        display: none;
      }
      
      th, td {
        padding: 0.75rem 0.5rem;
      }
      
      .table-section {
        overflow-x: auto;
      }
      
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .page-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .stats-bar {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>

<body data-theme="dark">
  <header class="header">
    <div class="container flex-between">
      <div class="logo"><a href="index.html" class="flex-center"><i class="fas fa-filter"></i><span>Screener</span></a></div>
      <nav class="nav-links">
        <a href="chart.html">Chart</a>
        <a href="watchlist.html">Watchlist</a>
        <a href="screener.html">Screener</a>
        <a href="ideas.html">Ideas</a>
        <a href="alerts.html">Alerts</a>
      </nav>
      <div class="header-actions">
        <button id="theme-toggle" class="icon-btn"><i class="fas fa-moon"></i></button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Crypto Screener</h1>
        <p class="page-subtitle">Track 2300+ cryptocurrencies with real-time market data</p>
      </div>
      <div class="page-actions">
        <button class="btn btn-outline" id="export-btn"><i class="fas fa-download"></i> Export</button>
        <button class="btn btn-primary" onclick="window.location.href='alerts.html'"><i class="fas fa-plus"></i> Create Alert</button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value">2300+</div>
        <div class="stat-label">Total Assets</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">$1.8T</div>
        <div class="stat-label">Total Market Cap</div>
        <div class="stat-change positive"><i class="fas fa-caret-up"></i> +2.4%</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">$85B</div>
        <div class="stat-label">24h Volume</div>
        <div class="stat-change negative"><i class="fas fa-caret-down"></i> -1.2%</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">1,742</div>
        <div class="stat-label">Assets Up</div>
        <div class="stat-change positive"><i class="fas fa-caret-up"></i> 65%</div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filters-header">
        <div class="filters-title">Filters</div>
        <button class="filters-toggle">
          <i class="fas fa-sliders-h"></i>
          <span>Advanced</span>
        </button>
      </div>
      <div class="filters-content">
        <div class="filter-group">
          <label>Search Symbol</label>
          <div id="symbol-search-container">
            <input type="text" id="symbol-search-input" placeholder="e.g. BTC, ETH, SOL...">
            <div id="symbol-search-dropdown"></div>
          </div>
        </div>
        <div class="filter-group">
          <label>Market Cap</label>
          <select id="market-cap">
            <option value="">All</option>
            <option value="mega">Mega (> $100B)</option>
            <option value="large">Large ($10B - $100B)</option>
            <option value="mid">Mid ($1B - $10B)</option>
            <option value="small">Small ($100M - $1B)</option>
            <option value="micro">Micro (< $100M)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Price Change (24h)</label>
          <select id="change-filter">
            <option value="">All</option>
            <option value="positive">Gainers (+%)</option>
            <option value="negative">Losers (-%)</option>
            <option value="high-gain">High Gain (> +10%)</option>
            <option value="high-loss">High Loss (< -10%)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Min Volume (24h)</label>
          <input type="number" id="min-volume" placeholder="Min Volume (USD)">
        </div>
      </div>
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="flex-center" style="margin-bottom:1rem;">
      <span class="status-indicator status-connecting"></span>
      <span>Loading 2300+ symbols with market data...</span>
    </div>

    <!-- Table Section -->
    <div class="table-section">
      <div class="table-header">
        <div class="table-title">Cryptocurrencies</div>
        <div class="table-actions">
          <select id="rows-per-page">
            <option value="25">25 rows</option>
            <option value="50">50 rows</option>
            <option value="100" selected>100 rows</option>
            <option value="250">250 rows</option>
          </select>
        </div>
      </div>
      <table id="screener-table">
        <thead>
          <tr>
            <th class="sortable" data-col="symbol">Symbol</th>
            <th class="sortable" data-col="price">Price (USDT)</th>
            <th class="sortable" data-col="change">24h Change</th>
            <th class="sortable" data-col="volume">24h Volume</th>
            <th class="sortable" data-col="marketCap">Market Cap</th>
            <th class="sortable" data-col="fdv">FDV Ratio</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="screener-body">
          <tr><td colspan="7" class="loading">Loading live data with market cap and FDV ratios...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="export-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Export Data</h3>
        <button class="modal-close" id="close-modal">&times;</button>
      </div>
      <div class="export-options">
        <div class="export-option selected" data-format="csv">
          <div class="export-icon">
            <i class="fas fa-file-csv"></i>
          </div>
          <div class="export-info">
            <h4>CSV Format</h4>
            <p>Comma-separated values, compatible with Excel and Google Sheets</p>
          </div>
        </div>
        <div class="export-option" data-format="json">
          <div class="export-icon">
            <i class="fas fa-file-code"></i>
          </div>
          <div class="export-info">
            <h4>JSON Format</h4>
            <p>JavaScript Object Notation, ideal for developers and APIs</p>
          </div>
        </div>
        <div class="export-option" data-format="xlsx">
          <div class="export-icon">
            <i class="fas fa-file-excel"></i>
          </div>
          <div class="export-info">
            <h4>Excel Format</h4>
            <p>Microsoft Excel format with formatting and multiple sheets</p>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" id="cancel-export">Cancel</button>
        <button class="btn btn-primary" id="confirm-export">Export</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">Â© 2025 TradeVision. Open Source.</div>
  </footer>

  <script>
    // Theme Toggle
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const themeIcon = themeToggle.querySelector('i');
    themeToggle.addEventListener('click', () => {
      const isDark = body.getAttribute('data-theme') === 'dark';
      body.setAttribute('data-theme', isDark ? 'light' : 'dark');
      themeIcon.classList.toggle('fa-moon'); 
      themeIcon.classList.toggle('fa-sun');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    });
    const savedTheme = localStorage.getItem('theme') || 'dark';
    body.setAttribute('data-theme', savedTheme);
    if (savedTheme === 'light') themeIcon.classList.replace('fa-moon', 'fa-sun');

    // API URLs
    const BINANCE_INFO_URL = 'https://api.binance.com/api/v3/exchangeInfo';
    const BINANCE_TICKER_URL = 'wss://stream.binance.com:9443/ws/!ticker@arr';
    const COINGECKO_API = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false&price_change_percentage=24h';

    // Global variables
    let allSymbols = [];
    let marketCapData = {}; // symbol â†’ {marketCap, fdv, circulatingSupply, totalSupply}
    let liveData = {}; // symbol â†’ {price, change, volume}
    let ws = null;
    let sortCol = 'marketCap';
    let sortAsc = false; // Default sort by market cap descending

    // Fetch Market Cap Data from CoinGecko
    async function loadMarketCapData() {
      try {
        const response = await fetch(COINGECKO_API);
        const data = await response.json();
        
        // Create mapping from CoinGecko data
        data.forEach(coin => {
          const symbol = coin.symbol.toUpperCase() + 'USDT';
          marketCapData[symbol] = {
            marketCap: coin.market_cap || 0,
            fdv: coin.fully_diluted_valuation || 0,
            circulatingSupply: coin.circulating_supply || 0,
            totalSupply: coin.total_supply || 0,
            fdvRatio: coin.fully_diluted_valuation && coin.market_cap ? 
                     (coin.fully_diluted_valuation / coin.market_cap).toFixed(2) : 'N/A'
          };
        });
        
        console.log(`Loaded market cap data for ${Object.keys(marketCapData).length} coins`);
      } catch (error) {
        console.error('Error loading market cap data:', error);
        // Fallback: Use estimated market caps based on price and supply
        estimateMarketCaps();
      }
    }

    // Estimate market caps for coins not in CoinGecko data
    function estimateMarketCaps() {
      allSymbols.forEach(symbol => {
        if (!marketCapData[symbol.symbol]) {
          const price = liveData[symbol.symbol]?.price || 1;
          // Estimate supply based on symbol (this is very rough estimation)
          let estimatedSupply = 1000000; // Default 1M supply
          
          if (symbol.symbol.includes('BTC')) estimatedSupply = 21000000;
          else if (symbol.symbol.includes('ETH')) estimatedSupply = 120000000;
          else if (symbol.symbol.includes('ADA')) estimatedSupply = 45000000000;
          else if (symbol.symbol.includes('DOT')) estimatedSupply = 1200000000;
          else if (symbol.symbol.includes('SOL')) estimatedSupply = 573000000;
          else if (symbol.symbol.includes('XRP')) estimatedSupply = 100000000000;
          else if (symbol.symbol.includes('DOGE')) estimatedSupply = 132000000000;
          else if (symbol.symbol.includes('MATIC')) estimatedSupply = 10000000000;
          else if (symbol.symbol.includes('BNB')) estimatedSupply = 157000000;
          else if (symbol.symbol.includes('LTC')) estimatedSupply = 72000000;
          else if (symbol.symbol.includes('LINK')) estimatedSupply = 1000000000;
          else if (symbol.symbol.includes('UNI')) estimatedSupply = 1000000000;
          else if (symbol.symbol.includes('AVAX')) estimatedSupply = 720000000;
          
          const marketCap = price * estimatedSupply;
          const fdv = price * (estimatedSupply * 1.1); // Assume 10% more for FDV
          
          marketCapData[symbol.symbol] = {
            marketCap: marketCap,
            fdv: fdv,
            circulatingSupply: estimatedSupply,
            totalSupply: estimatedSupply * 1.1,
            fdvRatio: (fdv / marketCap).toFixed(2)
          };
        }
      });
    }

    // Fetch All 2300+ Symbols from Binance
    async function loadSymbols() {
      try {
        const response = await fetch(BINANCE_INFO_URL);
        const data = await response.json();
        
        // Load market cap data first
        await loadMarketCapData();
        
        allSymbols = data.symbols
          .filter(s => s.status === 'TRADING' && s.quoteAsset === 'USDT' && s.baseAsset !== 'USD')
          .map(s => ({ 
            symbol: s.symbol, 
            name: s.baseAsset,
            price: 0, 
            change: 0, 
            volume: 0,
            marketCap: marketCapData[s.symbol]?.marketCap || 0,
            fdvRatio: marketCapData[s.symbol]?.fdvRatio || 'N/A'
          }))
          .sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0)); // Sort by market cap by default
        
        renderTable(allSymbols);
        connectWebSocket();
        document.getElementById('connection-status').innerHTML = 
          '<span class="status-indicator status-connected"></span><span>Live Data (2300+ Symbols with Market Cap)</span>';
          
      } catch (error) {
        console.error('Error loading symbols:', error);
        document.getElementById('connection-status').innerHTML = 
          '<span class="status-indicator status-disconnected"></span><span>Error loading symbols</span>';
        
        // Fallback mock data with market caps
        allSymbols = [
          { symbol: 'BTCUSDT', name: 'Bitcoin', price: 45000, change: 2.5, volume: 1230000000, marketCap: 880000000000, fdvRatio: '1.00' },
          { symbol: 'ETHUSDT', name: 'Ethereum', price: 2500, change: -1.2, volume: 850000000, marketCap: 300000000000, fdvRatio: '1.05' },
          { symbol: 'BNBUSDT', name: 'Binance Coin', price: 320, change: 0.8, volume: 450000000, marketCap: 50000000000, fdvRatio: '1.02' },
          { symbol: 'SOLUSDT', name: 'Solana', price: 120, change: 5.2, volume: 450000000, marketCap: 68000000000, fdvRatio: '1.15' },
          { symbol: 'XRPUSDT', name: 'Ripple', price: 0.6, change: -2.1, volume: 800000000, marketCap: 32000000000, fdvRatio: '1.25' },
          { symbol: 'ADAUSDT', name: 'Cardano', price: 0.5, change: 3.1, volume: 150000000, marketCap: 18000000000, fdvRatio: '1.30' },
          { symbol: 'DOGEUSDT', name: 'Dogecoin', price: 0.15, change: 8.7, volume: 600000000, marketCap: 21000000000, fdvRatio: '1.50' },
          { symbol: 'DOTUSDT', name: 'Polkadot', price: 7, change: -0.8, volume: 95000000, marketCap: 8400000000, fdvRatio: '1.12' },
          { symbol: 'MATICUSDT', name: 'Polygon', price: 1.2, change: -3.5, volume: 300000000, marketCap: 11000000000, fdvRatio: '1.08' },
          { symbol: 'AVAXUSDT', name: 'Avalanche', price: 40, change: 2.3, volume: 200000000, marketCap: 15000000000, fdvRatio: '1.20' }
        ];
        renderTable(allSymbols);
      }
    }

    // WebSocket for Live Data (All Tickers)
    function connectWebSocket() {
      ws = new WebSocket(BINANCE_TICKER_URL);
      ws.onopen = () => console.log('Connected to Binance Tickers');
      ws.onmessage = (event) => {
        const tickers = JSON.parse(event.data);
        tickers.forEach(t => {
          const symbol = t.s;
          if (allSymbols.find(s => s.symbol === symbol)) {
            liveData[symbol] = {
              price: parseFloat(t.c),
              change: parseFloat(t.P),
              volume: parseFloat(t.v)
            };
            
            // Update market cap with live price if we have supply data
            if (marketCapData[symbol] && marketCapData[symbol].circulatingSupply) {
              const newMarketCap = parseFloat(t.c) * marketCapData[symbol].circulatingSupply;
              marketCapData[symbol].marketCap = newMarketCap;
              
              // Update FDV if we have total supply
              if (marketCapData[symbol].totalSupply) {
                const newFDV = parseFloat(t.c) * marketCapData[symbol].totalSupply;
                marketCapData[symbol].fdv = newFDV;
                marketCapData[symbol].fdvRatio = (newFDV / newMarketCap).toFixed(2);
              }
            }
          }
        });
        renderTable(allSymbols);
      };
      ws.onclose = () => setTimeout(connectWebSocket, 3000);
      ws.onerror = (err) => console.error('WebSocket error:', err);
    }

    // Format large numbers
    function formatNumber(num) {
      if (num >= 1000000000000) {
        return '$' + (num / 1000000000000).toFixed(2) + 'T';
      } else if (num >= 1000000000) {
        return '$' + (num / 1000000000).toFixed(2) + 'B';
      } else if (num >= 1000000) {
        return '$' + (num / 1000000).toFixed(2) + 'M';
      } else if (num >= 1000) {
        return '$' + (num / 1000).toFixed(2) + 'K';
      }
      return '$' + num.toFixed(2);
    }

    // Format FDV ratio with color coding
    function formatFDVRatio(ratio) {
      if (ratio === 'N/A' || !ratio) return '--';
      
      const num = parseFloat(ratio);
      let colorClass = '';
      
      if (num < 1.05) colorClass = 'change'; // Green for low FDV (good)
      else if (num < 1.5) colorClass = ''; // Neutral
      else colorClass = 'change negative'; // Red for high FDV (potentially overvalued)
      
      return `<span class="${colorClass}">${ratio}x</span>`;
    }

    // Render Table
    function renderTable(symbols) {
      const tbody = document.getElementById('screener-body');
      const filtered = symbols.filter(s => {
        const search = document.getElementById('symbol-search-input').value.toLowerCase();
        if (search && !s.name.toLowerCase().includes(search) && !s.symbol.toLowerCase().includes(search)) return false;
        
        const capFilter = document.getElementById('market-cap').value;
        const marketCap = marketCapData[s.symbol]?.marketCap || s.marketCap || 0;
        if (capFilter === 'mega' && marketCap < 100000000000) return false;
        if (capFilter === 'large' && (marketCap < 10000000000 || marketCap >= 100000000000)) return false;
        if (capFilter === 'mid' && (marketCap < 1000000000 || marketCap >= 10000000000)) return false;
        if (capFilter === 'small' && (marketCap < 100000000 || marketCap >= 1000000000)) return false;
        if (capFilter === 'micro' && marketCap >= 100000000) return false;
        
        const volFilter = document.getElementById('min-volume').value;
        if (volFilter && (liveData[s.symbol]?.volume || 0) < parseFloat(volFilter)) return false;
        
        const changeFilter = document.getElementById('change-filter').value;
        const change = liveData[s.symbol]?.change || 0;
        if (changeFilter === 'positive' && change < 0) return false;
        if (changeFilter === 'negative' && change >= 0) return false;
        if (changeFilter === 'high-gain' && change < 10) return false;
        if (changeFilter === 'high-loss' && change > -10) return false;
        
        return true;
      }).sort((a, b) => {
        let valA, valB;
        
        if (sortCol === 'marketCap') {
          valA = marketCapData[a.symbol]?.marketCap || a.marketCap || 0;
          valB = marketCapData[b.symbol]?.marketCap || b.marketCap || 0;
        } else if (sortCol === 'fdv') {
          valA = parseFloat(marketCapData[a.symbol]?.fdvRatio) || 0;
          valB = parseFloat(marketCapData[b.symbol]?.fdvRatio) || 0;
        } else if (sortCol === 'symbol') {
          return sortAsc ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
        } else {
          valA = liveData[a.symbol]?.[sortCol] || a[sortCol];
          valB = liveData[b.symbol]?.[sortCol] || b[sortCol];
        }
        
        return sortAsc ? valA - valB : valB - valA;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-results">No results found. Try adjusting your filters.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(s => {
        const live = liveData[s.symbol] || {};
        const marketInfo = marketCapData[s.symbol] || {};
        const changeClass = live.change >= 0 ? 'change' : 'change negative';
        const watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
        const isInWatchlist = watchlist.includes(s.symbol);
        const buttonText = isInWatchlist ? 'Added' : '+ Watch';
        const buttonClass = isInWatchlist ? 'action-btn added' : 'action-btn';
        
        return `<tr>
          <td><a href="chart.html?symbol=${s.symbol}">${s.symbol}</a></td>
          <td>${live.price ? live.price.toFixed(4) : '--'}</td>
          <td><span class="${changeClass}">${live.change ? (live.change >= 0 ? '+' : '') + live.change.toFixed(2) + '%' : '--'}</span></td>
          <td>${live.volume ? formatNumber(live.volume) : '--'}</td>
          <td>${marketInfo.marketCap ? formatNumber(marketInfo.marketCap) : '--'}</td>
          <td>${formatFDVRatio(marketInfo.fdvRatio)}</td>
          <td><button class="${buttonClass}" data-sym="${s.symbol}" ${isInWatchlist ? 'disabled' : ''}>${buttonText}</button></td>
        </tr>`;
      }).join('');
      
      updateSortIndicators();
    }

    // Update sort indicators in table headers
    function updateSortIndicators() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.col === sortCol) {
          th.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    // Symbol Search Dropdown
    document.getElementById('symbol-search-input').addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const dropdown = document.getElementById('symbol-search-dropdown');
      if (term.length < 2) {
        dropdown.innerHTML = '';
        dropdown.style.display = 'none';
        return;
      }
      const matches = allSymbols.filter(s => s.symbol.toLowerCase().includes(term) || s.name.toLowerCase().includes(term)).slice(0, 10);
      dropdown.innerHTML = matches.map(s => `<div class="symbol-option" onclick="selectSymbol('${s.symbol}')">${s.symbol} - ${s.name}</div>`).join('');
      dropdown.style.display = matches.length > 0 ? 'block' : 'none';
    });

    function selectSymbol(symbol) {
      document.getElementById('symbol-search-input').value = symbol;
      document.getElementById('symbol-search-dropdown').style.display = 'none';
      renderTable(allSymbols);
    }

    // Sorting
    document.querySelectorAll('.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = true; }
        renderTable(allSymbols);
      });
    });

    // Add to Watchlist
    document.getElementById('screener-table').addEventListener('click', e => {
      if (e.target.classList.contains('action-btn') && !e.target.classList.contains('added')) {
        const sym = e.target.dataset.sym;
        let watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
        if (!watchlist.includes(sym)) {
          watchlist.push(sym);
          localStorage.setItem('watchlist', JSON.stringify(watchlist));
          e.target.textContent = 'Added';
          e.target.classList.add('added');
          e.target.disabled = true;
        }
      }
    });

    // Filter event listeners
    document.getElementById('market-cap').addEventListener('change', () => renderTable(allSymbols));
    document.getElementById('change-filter').addEventListener('change', () => renderTable(allSymbols));
    document.getElementById('min-volume').addEventListener('input', () => renderTable(allSymbols));

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#symbol-search-container')) {
        document.getElementById('symbol-search-dropdown').style.display = 'none';
      }
    });

    // Export functionality
    let selectedExportFormat = 'csv';

    // Export modal handling
    const exportBtn = document.getElementById('export-btn');
    const exportModal = document.getElementById('export-modal');
    const closeModal = document.getElementById('close-modal');
    const cancelExport = document.getElementById('cancel-export');
    const confirmExport = document.getElementById('confirm-export');
    const exportOptions = document.querySelectorAll('.export-option');

    // Open export modal
    exportBtn.addEventListener('click', () => {
      exportModal.style.display = 'flex';
    });

    // Close export modal
    function closeExportModal() {
      exportModal.style.display = 'none';
    }

    closeModal.addEventListener('click', closeExportModal);
    cancelExport.addEventListener('click', closeExportModal);

    // Select export format
    exportOptions.forEach(option => {
      option.addEventListener('click', () => {
        exportOptions.forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedExportFormat = option.dataset.format;
      });
    });

    // Perform export
    confirmExport.addEventListener('click', () => {
      closeExportModal();
      exportData(selectedExportFormat);
    });

    // Export data function
    function exportData(format) {
      // Get current filtered data
      const filteredSymbols = getFilteredSymbols();
      
      switch(format) {
        case 'csv':
          exportToCSV(filteredSymbols);
          break;
        case 'json':
          exportToJSON(filteredSymbols);
          break;
        case 'xlsx':
          exportToExcel(filteredSymbols);
          break;
      }
    }

    // Get filtered symbols (reuse the filtering logic from renderTable)
    function getFilteredSymbols() {
      return allSymbols.filter(s => {
        const search = document.getElementById('symbol-search-input').value.toLowerCase();
        if (search && !s.name.toLowerCase().includes(search) && !s.symbol.toLowerCase().includes(search)) return false;
        
        const capFilter = document.getElementById('market-cap').value;
        const marketCap = marketCapData[s.symbol]?.marketCap || s.marketCap || 0;
        if (capFilter === 'mega' && marketCap < 100000000000) return false;
        if (capFilter === 'large' && (marketCap < 10000000000 || marketCap >= 100000000000)) return false;
        if (capFilter === 'mid' && (marketCap < 1000000000 || marketCap >= 10000000000)) return false;
        if (capFilter === 'small' && (marketCap < 100000000 || marketCap >= 1000000000)) return false;
        if (capFilter === 'micro' && marketCap >= 100000000) return false;
        
        const volFilter = document.getElementById('min-volume').value;
        if (volFilter && (liveData[s.symbol]?.volume || 0) < parseFloat(volFilter)) return false;
        
        const changeFilter = document.getElementById('change-filter').value;
        const change = liveData[s.symbol]?.change || 0;
        if (changeFilter === 'positive' && change < 0) return false;
        if (changeFilter === 'negative' && change >= 0) return false;
        if (changeFilter === 'high-gain' && change < 10) return false;
        if (changeFilter === 'high-loss' && change > -10) return false;
        
        return true;
      });
    }

    // Export to CSV
    function exportToCSV(symbols) {
      const headers = ['Symbol', 'Name', 'Price', '24h Change %', '24h Volume', 'Market Cap', 'FDV Ratio'];
      const csvContent = [
        headers.join(','),
        ...symbols.map(s => {
          const live = liveData[s.symbol] || {};
          const marketInfo = marketCapData[s.symbol] || {};
          return [
            `"${s.symbol}"`,
            `"${s.name}"`,
            live.price || '--',
            live.change || '--',
            live.volume || '--',
            marketInfo.marketCap || '--',
            marketInfo.fdvRatio || '--'
          ].join(',');
        })
      ].join('\n');

      downloadFile(csvContent, 'crypto-screener-data.csv', 'text/csv');
    }

    // Export to JSON
    function exportToJSON(symbols) {
      const data = symbols.map(s => {
        const live = liveData[s.symbol] || {};
        const marketInfo = marketCapData[s.symbol] || {};
        return {
          symbol: s.symbol,
          name: s.name,
          price: live.price || null,
          change24h: live.change || null,
          volume24h: live.volume || null,
          marketCap: marketInfo.marketCap || null,
          fdvRatio: marketInfo.fdvRatio || null,
          lastUpdated: new Date().toISOString()
        };
      });

      downloadFile(JSON.stringify(data, null, 2), 'crypto-screener-data.json', 'application/json');
    }

    // Export to Excel
    function exportToExcel(symbols) {
      try {
        // Prepare data for Excel
        const excelData = symbols.map(s => {
          const live = liveData[s.symbol] || {};
          const marketInfo = marketCapData[s.symbol] || {};
          return {
            'Symbol': s.symbol,
            'Name': s.name,
            'Price (USDT)': live.price || '--',
            '24h Change %': live.change || '--',
            '24h Volume': live.volume || '--',
            'Market Cap': marketInfo.marketCap || '--',
            'FDV Ratio': marketInfo.fdvRatio || '--'
          };
        });

        // Create worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Crypto Data');
        
        // Generate Excel file and download
        XLSX.writeFile(wb, 'crypto-screener-data.xlsx');
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Error exporting to Excel. Please try another format.');
      }
    }

    // Download file utility
    function downloadFile(content, fileName, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === exportModal) {
        closeExportModal();
      }
    });

    // Load on startup
    loadSymbols();
  </script>
</body>
</html>
